<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maré Territory Map - Crime Denunciations</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <!-- Marker Cluster CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f7fa;
        }
        .container {
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .header h1 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 24px;
        }
        .header p {
            margin: 0;
            color: #7f8c8d;
            font-size: 14px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .control-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .control-btn.active {
            background: #e74c3c;
        }
        #map {
            flex: 1;
            width: 100%;
            position: relative;
        }
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 250px;
        }
        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #2c3e50;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid rgba(0,0,0,0.2);
        }
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 200px;
        }
        .info-panel h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #2c3e50;
        }
        .info-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }
        .info-stat span:first-child {
            color: #7f8c8d;
        }
        .info-stat span:last-child {
            font-weight: 600;
            color: #2c3e50;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 2000;
        }
        .footer {
            text-align: center;
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            color: #7f8c8d;
            font-size: 14px;
        }
        .footer a {
            color: #3498db;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Maré Territory Map - Crime Denunciations</h1>
            <p>Geographic distribution of denunciations and police operations</p>
            <div class="controls">
                <button class="control-btn active" onclick="showAllPoints()">All Denunciations</button>
                <button class="control-btn" onclick="filterByTerritory('ADA-TCP')">ADA-TCP</button>
                <button class="control-btn" onclick="filterByTerritory('CVNH')">CVNH</button>
                <button class="control-btn" onclick="filterByTerritory('CVPU')">CVPU</button>
                <button class="control-btn" onclick="filterByTerritory('TCP')">TCP</button>
                <button class="control-btn" onclick="filterByTerritory('TCP-milicia')">TCP-Milícia</button>
                <button class="control-btn" onclick="toggleHeatmap()">Toggle Heatmap</button>
            </div>
        </div>

        <div id="map">
            <div class="loading" id="loading">Loading map data...</div>
            <div class="info-panel">
                <h4>Statistics</h4>
                <div class="info-stat">
                    <span>Total Points:</span>
                    <span id="totalPoints">-</span>
                </div>
                <div class="info-stat">
                    <span>Visible:</span>
                    <span id="visiblePoints">-</span>
                </div>
                <div class="info-stat">
                    <span>Operations:</span>
                    <span id="operationsCount">-</span>
                </div>
            </div>
            <div class="legend">
                <h4>Territory Types</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span>ADA-TCP</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3498db;"></div>
                    <span>CVNH</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2ecc71;"></div>
                    <span>CVPU</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9b59b6;"></div>
                    <span>TCP</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f39c12;"></div>
                    <span>TCP-Milícia</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #95a5a6;"></div>
                    <span>Unassigned</span>
                </div>
            </div>
        </div>

        <div class="footer">
            Data Visualisation and Statistical Analysis by Katelyn Nutley | 
            <a href="https://github.com/knutley/Barnes_Mare" target="_blank">Source Code Here</a>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <!-- Marker Cluster JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        // Maré coordinates (approximate center)
        const MARE_CENTER = [-22.8518, -43.2431];
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSOJAMw024OWRdnyE-y4MA4YFJS7mLbyhwIpzR8USCVq_2Nq6mcm_An1Xzt1kAgYhrU9zjks4ea0tbA/pub?output=csv';
        
        let map;
        let markerCluster;
        let allMarkers = [];
        let rawData = [];
        let marePolygon;

        // Territory colors
        const territoryColors = {
            'ADA-TCP': '#e74c3c',
            'CVNH': '#3498db',
            'CVPU': '#2ecc71',
            'TCP': '#9b59b6',
            'TCP-milicia': '#f39c12',
            'unassigned': '#95a5a6'
        };

        // Initialize map
        function initMap() {
            map = L.map('map').setView(MARE_CENTER, 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            // Add Maré boundary (approximate polygon - you'll need to replace with actual shapefile data)
            // This is a placeholder - you need to convert your shapefile to GeoJSON
            const mareBoundary = {
                "type": "Feature",
                "properties": {"name": "Maré"},
                "geometry": {
                    "type": "Polygon",
                    "coordinates": [[
                        [-43.2531, -22.8418],
                        [-43.2331, -22.8418],
                        [-43.2331, -22.8618],
                        [-43.2531, -22.8618],
                        [-43.2531, -22.8418]
                    ]]
                }
            };

            marePolygon = L.geoJSON(mareBoundary, {
                style: {
                    color: '#2c3e50',
                    weight: 2,
                    fillOpacity: 0.1,
                    fillColor: '#3498db'
                }
            }).addTo(map);

            // Initialize marker cluster group
            markerCluster = L.markerClusterGroup({
                chunkedLoading: true,
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count > 100) size = 'large';
                    else if (count > 50) size = 'medium';
                    
                    return L.divIcon({
                        html: '<div><span>' + count + '</span></div>',
                        className: 'marker-cluster marker-cluster-' + size,
                        iconSize: L.point(40, 40)
                    });
                }
            });

            map.addLayer(markerCluster);
        }

        // Load and process data
        async function loadData() {
            try {
                Papa.parse(SHEET_URL, {
                    download: true,
                    header: true,
                    complete: function(results) {
                        rawData = results.data.filter(row => row.date && row.date !== 'NA');
                        processDataAndCreateMarkers();
                        document.getElementById('loading').style.display = 'none';
                    },
                    error: function(error) {
                        document.getElementById('loading').innerHTML = 'Error: ' + error.message;
                    }
                });
            } catch (error) {
                document.getElementById('loading').innerHTML = 'Error: ' + error.message;
            }
        }

        function processDataAndCreateMarkers() {
            // NOTE: This assumes your CSV has lat/lon columns
            // If you don't have coordinates, you'll need to geocode or add them
            
            allMarkers = [];
            let operationsCount = 0;

            rawData.forEach((row, index) => {
                // IMPORTANT: Replace these with your actual coordinate column names
                // If you don't have coordinates, you'll need to add them or use random points within Maré
                let lat = row.latitude || generateRandomCoordInMare().lat;
                let lon = row.longitude || generateRandomCoordInMare().lng;

                const territory = row.territory_type || 'unassigned';
                const color = territoryColors[territory] || '#95a5a6';
                const isOperation = row.operations === '1';
                
                if (isOperation) operationsCount++;

                const marker = L.circleMarker([lat, lon], {
                    radius: isOperation ? 8 : 5,
                    fillColor: color,
                    color: isOperation ? '#000' : color,
                    weight: isOperation ? 2 : 1,
                    opacity: 1,
                    fillOpacity: 0.7,
                    territory: territory,
                    isOperation: isOperation
                });

                const popupContent = `
                    <strong>Date:</strong> ${row.date}<br>
                    <strong>Territory:</strong> ${territory}<br>
                    <strong>Crime Type:</strong> ${row.crime_type || 'N/A'}<br>
                    <strong>Operation:</strong> ${isOperation ? 'Yes' : 'No'}
                `;
                
                marker.bindPopup(popupContent);
                allMarkers.push(marker);
            });

            markerCluster.addLayers(allMarkers);
            updateStats(allMarkers.length, allMarkers.length, operationsCount);
        }

        // Generate random coordinates within Maré (for demo purposes)
        // Remove this if you have actual coordinates
        function generateRandomCoordInMare() {
            const latOffset = (Math.random() - 0.5) * 0.02;
            const lngOffset = (Math.random() - 0.5) * 0.02;
            return {
                lat: MARE_CENTER[0] + latOffset,
                lng: MARE_CENTER[1] + lngOffset
            };
        }

        function updateStats(total, visible, operations) {
            document.getElementById('totalPoints').textContent = total;
            document.getElementById('visiblePoints').textContent = visible;
            document.getElementById('operationsCount').textContent = operations;
        }

        function showAllPoints() {
            document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            markerCluster.clearLayers();
            markerCluster.addLayers(allMarkers);
            
            const operations = allMarkers.filter(m => m.options.isOperation).length;
            updateStats(allMarkers.length, allMarkers.length, operations);
        }

        function filterByTerritory(territory) {
            document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const filtered = allMarkers.filter(m => m.options.territory === territory);
            markerCluster.clearLayers();
            markerCluster.addLayers(filtered);
            
            const operations = filtered.filter(m => m.options.isOperation).length;
            updateStats(allMarkers.length, filtered.length, operations);
        }

        function toggleHeatmap() {
            // Placeholder for heatmap functionality
            // Would require leaflet.heat plugin
            alert('Heatmap functionality requires additional setup. See leaflet.heat plugin.');
        }

        // Initialize
        window.onload = function() {
            initMap();
            loadData();
        };
    </script>

    <style>
        /* Cluster styling */
        .marker-cluster-small {
            background-color: rgba(181, 226, 140, 0.6);
        }
        .marker-cluster-small div {
            background-color: rgba(110, 204, 57, 0.6);
        }
        .marker-cluster-medium {
            background-color: rgba(241, 211, 87, 0.6);
        }
        .marker-cluster-medium div {
            background-color: rgba(240, 194, 12, 0.6);
        }
        .marker-cluster-large {
            background-color: rgba(253, 156, 115, 0.6);
        }
        .marker-cluster-large div {
            background-color: rgba(241, 128, 23, 0.6);
        }
        .marker-cluster {
            background-clip: padding-box;
            border-radius: 20px;
        }
        .marker-cluster div {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            margin-top: 5px;
            text-align: center;
            border-radius: 15px;
            font: 12px "Helvetica Neue", Arial, Helvetica, sans-serif;
        }
        .marker-cluster span {
            line-height: 30px;
        }
    </style>
</body>
</html>
